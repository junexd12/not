-- PLAYER VISIBILITY + BEAM ENFORCER
-- Forces ALL parts of other players visible
-- Adds forced blue beam to "ponto"
-- Excludes HumanoidRootPart and hitbox
-- PC: X key | Mobile: draggable button

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local localPlayer = Players.LocalPlayer
local enabled = false

-- =====================
-- BEAM SETTINGS
-- =====================
local BEAM_NAME = "ForcedBlueBeam"
local BEAM_COLOR = Color3.fromRGB(0, 145, 250)
local BEAM_LENGTH = 100

local function createBeam(ponto: BasePart)
	local a0 = ponto:FindFirstChild("BeamAttachment0") or Instance.new("Attachment")
	a0.Name = "BeamAttachment0"
	a0.Position = Vector3.zero
	a0.Parent = ponto

	local a1 = ponto:FindFirstChild("BeamAttachment1") or Instance.new("Attachment")
	a1.Name = "BeamAttachment1"
	a1.Position = Vector3.new(0, 0, BEAM_LENGTH)
	a1.Parent = ponto

	local beam = ponto:FindFirstChild(BEAM_NAME) or Instance.new("Beam")
	beam.Name = BEAM_NAME
	beam.Attachment0 = a0
	beam.Attachment1 = a1
	beam.Width0 = 0.2
	beam.Width1 = 0.2
	beam.FaceCamera = true
	beam.Color = ColorSequence.new(BEAM_COLOR)
	beam.Transparency = NumberSequence.new(0)
	beam.LightEmission = 1
	beam.LightInfluence = 0
	beam.Enabled = true
	beam.Parent = ponto
end

-- =====================
-- FORCE EVERYTHING VISIBLE
-- =====================
local function enforceCharacter(character)
	for _, obj in ipairs(character:GetDescendants()) do
		if obj:IsA("BasePart") then
			if obj.Name ~= "HumanoidRootPart" and obj.Name ~= "hitbox" then
				obj.Transparency = 0
				obj.LocalTransparencyModifier = 0
			end

			if obj.Name == "ponto" then
				createBeam(obj)
			end
		end
	end
end

-- =====================
-- LOOP (ANTI-INVIS + ANTI-REMOVE)
-- =====================
RunService.RenderStepped:Connect(function()
	if not enabled then return end

	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= localPlayer then
			local char = player.Character
			if char then
				enforceCharacter(char)
			end
		end
	end
end)

-- =====================
-- TOGGLE
-- =====================
local function toggle()
	enabled = not enabled
end

-- =====================
-- PC â†’ X KEY
-- =====================
UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.X then
		toggle()
	end
end)

-- =====================
-- MOBILE BUTTON (DRAGGABLE)
-- =====================
if UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled then
	local gui = Instance.new("ScreenGui")
	gui.ResetOnSpawn = false
	gui.Parent = localPlayer:WaitForChild("PlayerGui")

	local button = Instance.new("TextButton")
	button.Size = UDim2.fromScale(0.09, 0.09)
	button.Position = UDim2.fromScale(0.8, 0.8)
	button.AnchorPoint = Vector2.new(0.5, 0.5)
	button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
	button.Text = "ðŸ«¥"
	button.TextScaled = true
	button.TextColor3 = Color3.new(1, 1, 1)
	button.Parent = gui

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(1, 0)
	corner.Parent = button

	local dragging = false
	local moved = false
	local dragStart
	local startPos
	local TAP_THRESHOLD = 10

	button.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			moved = false
			dragStart = input.Position
			startPos = button.Position
		end
	end)

	button.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.Touch then
			dragging = false
			if not moved then
				toggle()
			end
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.Touch then
			local delta = input.Position - dragStart
			if delta.Magnitude > TAP_THRESHOLD then
				moved = true
			end

			button.Position = UDim2.new(
				startPos.X.Scale,
				startPos.X.Offset + delta.X,
				startPos.Y.Scale,
				startPos.Y.Offset + delta.Y
			)
		end
	end)
end
